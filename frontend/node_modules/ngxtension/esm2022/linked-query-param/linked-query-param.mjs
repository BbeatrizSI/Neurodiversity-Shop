import { effect, inject, Injectable, InjectionToken, runInInjectionContext, signal, untracked, } from '@angular/core';
import { toSignal } from '@angular/core/rxjs-interop';
import { ActivatedRoute, Router, } from '@angular/router';
import { assertInjector } from 'ngxtension/assert-injector';
import { createNotifier } from 'ngxtension/create-notifier';
import { explicitEffect } from 'ngxtension/explicit-effect';
import { distinctUntilKeyChanged, map } from 'rxjs';
import * as i0 from "@angular/core";
const defaultConfig = {
    queryParamsHandling: 'merge',
};
const _LINKED_QUERY_PARAM_CONFIG_TOKEN = new InjectionToken('LinkedQueryParamConfig', {
    providedIn: 'root',
    factory: () => defaultConfig,
});
/*
 * This function allows users to override the default behavior of the `linkedQueryParam` navigation extras per component.
 *
 * @example
 * ```ts
 * @Component({
 *   providers: [
 *     provideLinkedQueryParamConfig({ preserveFragment: true })
 *   ]
 * })
 * export class MyComponent {
 *   // No matter which query param changes, the `preserveFragment` option
 *   // will be set to `true` for all the `linkedQueryParam` functions in this component.
 *   readonly searchQuery = linkedQueryParam('searchQuery');
 *   readonly page = linkedQueryParam('page');
 * }
 * ```
 *
 * As always, you can override this behavior on a per-function basis by passing the navigation extras to the `linkedQueryParam` function.
 *
 */
export function provideLinkedQueryParamConfig(config) {
    return {
        provide: _LINKED_QUERY_PARAM_CONFIG_TOKEN,
        useValue: config,
    };
}
/**
 * Service to coalesce multiple navigation calls into a single navigation event.
 */
export class LinkedQueryParamGlobalHandler {
    constructor() {
        this._router = inject(Router);
        /**
         * @internal
         * The current query params that will be set on the next navigation event.
         */
        this._currentKeys = {};
        /**
         * @internal
         * The navigation extras that will be used on the next navigation event.
         */
        this._navigationExtras = {};
        /**
         * @internal
         * The notifier that will be used to schedule the navigation event.
         */
        this._schedulerNotifier = createNotifier();
        effect(() => {
            // listen to the scheduler notifier to schedule the navigation event
            // we wrap the listen in a condition (listen() default value is 0) in order to not schedule
            // the first navigation event by default, because only changes should trigger it
            if (this._schedulerNotifier.listen()) {
                // we need to untrack the navigation call in order to not register any other signal as a dependency
                untracked(() => void this.navigate());
            }
        });
    }
    /**
     * Schedules the navigation event.
     */
    scheduleNavigation() {
        this._schedulerNotifier.notify();
    }
    /**
     * Sets the value of a query param.
     * This will be used on the next navigation event.
     */
    setParamKeyValue(key, value) {
        this._currentKeys[key] = value;
    }
    /**
     * Sets the navigation extras that will be used on the next navigation event.
     */
    setCurrentNavigationExtras(config = {}) {
        const { queryParamsHandling, onSameUrlNavigation, replaceUrl, skipLocationChange, preserveFragment, } = config;
        if (queryParamsHandling || queryParamsHandling === '') {
            this._navigationExtras.queryParamsHandling = queryParamsHandling;
        }
        if (onSameUrlNavigation) {
            this._navigationExtras.onSameUrlNavigation = onSameUrlNavigation;
        }
        if (replaceUrl) {
            this._navigationExtras.replaceUrl = replaceUrl;
        }
        if (skipLocationChange) {
            this._navigationExtras.skipLocationChange = skipLocationChange;
        }
        if (preserveFragment) {
            this._navigationExtras.preserveFragment = preserveFragment;
        }
    }
    /**
     * Navigates to the current URL with the accumulated query parameters and navigation extras.
     * Cleans up the current keys and navigation extras after the navigation.
     */
    navigate() {
        return this._router
            .navigate([], {
            queryParams: this._currentKeys,
            ...this._navigationExtras, // override the navigation extras
        })
            .then((value) => {
            // we reset the current keys and navigation extras on navigation
            // in order to avoid leaking to other navigations
            this._currentKeys = {};
            this._navigationExtras = {};
            return value;
        });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.7", ngImport: i0, type: LinkedQueryParamGlobalHandler, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.7", ngImport: i0, type: LinkedQueryParamGlobalHandler, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.7", ngImport: i0, type: LinkedQueryParamGlobalHandler, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: () => [] });
export function linkedQueryParam(key, options) {
    if (options?.defaultValue !== undefined && options?.parse) {
        throw new Error('linkedQueryParam: You cannot have both defaultValue and parse at the same time!');
    }
    const injector = assertInjector(linkedQueryParam, options?.injector);
    return runInInjectionContext(injector, () => {
        const route = inject(ActivatedRoute);
        const globalHandler = inject(LinkedQueryParamGlobalHandler);
        const config = inject(_LINKED_QUERY_PARAM_CONFIG_TOKEN);
        /**
         * Parses a parameter value based on provided configuration.
         * @param params - An object containing parameters.
         * @returns The parsed parameter value.
         */
        const parseParamValue = (params) => {
            // Get the value from the params object.
            const value = params[key] ?? null;
            // If a parsing function is provided in the config, use it to parse the value.
            if (options?.parse) {
                return options.parse(value);
            }
            // If the value is undefined or null and a default value is provided, return the default value.
            if ((value === undefined || value === null) &&
                options?.defaultValue !== undefined) {
                return options.defaultValue;
            }
            // Otherwise, return the original value or the parsed value (if it was parsed).
            return value;
        };
        // create a signal that is updated whenever the query param changes
        const queryParamValue = toSignal(route.queryParams.pipe(distinctUntilKeyChanged(key), // skip if no changes on same key
        map((x) => parseParamValue(x))), { initialValue: parseParamValue(route.snapshot.queryParams) });
        const source = signal(queryParamValue());
        const originalSet = source.set;
        explicitEffect([queryParamValue], ([value]) => {
            // update the source signal whenever the query param changes
            originalSet(value);
        });
        const set = (value) => {
            // first we check if the value is undefined or null so we can set the default value instead
            if ((value === undefined || value === null) &&
                options?.defaultValue !== undefined) {
                value = options.defaultValue;
            }
            // we first set the initial value so it synchronous (same as a normal signal)
            originalSet(value);
            // when the source signal changes, update the query param
            // store the new value in the current keys so that we can coalesce the navigation
            let valueToBeSet = value;
            if (options?.stringify) {
                valueToBeSet = options.stringify(value);
            }
            else if (value === undefined || value === null) {
                valueToBeSet = null;
            }
            else {
                valueToBeSet = typeof value === 'string' ? value : String(value);
            }
            globalHandler.setParamKeyValue(key, valueToBeSet);
            globalHandler.setCurrentNavigationExtras({
                ...defaultConfig,
                ...config,
                ...(options ?? {}),
            });
            // schedule the navigation event (multiple synchronous navigations will be coalesced)
            // this will also reset the current keys and navigation extras after the navigation
            globalHandler.scheduleNavigation();
        };
        const update = (fn) => set(fn(source()));
        return Object.assign(source, { set, update });
    });
}
export function paramToNumber(config = { defaultValue: null }) {
    return (x) => {
        if (x === undefined || x === null)
            return config.defaultValue;
        const parsed = parseInt(x, 10);
        if (Number.isNaN(parsed))
            return config.defaultValue;
        return parsed;
    };
}
export function paramToBoolean(config = {
    defaultValue: null,
}) {
    return (x) => x === undefined || x === null ? config.defaultValue : x === 'true';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlua2VkLXF1ZXJ5LXBhcmFtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3h0ZW5zaW9uL2xpbmtlZC1xdWVyeS1wYXJhbS9zcmMvbGlua2VkLXF1ZXJ5LXBhcmFtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTixNQUFNLEVBQ04sTUFBTSxFQUNOLFVBQVUsRUFDVixjQUFjLEVBR2QscUJBQXFCLEVBQ3JCLE1BQU0sRUFDTixTQUFTLEdBRVQsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3RELE9BQU8sRUFDTixjQUFjLEVBR2QsTUFBTSxHQUNOLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUM1RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFNUQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQzs7QUFxQnBELE1BQU0sYUFBYSxHQUFrQztJQUNwRCxtQkFBbUIsRUFBRSxPQUFPO0NBQzVCLENBQUM7QUFFRixNQUFNLGdDQUFnQyxHQUFHLElBQUksY0FBYyxDQUV6RCx3QkFBd0IsRUFBRTtJQUMzQixVQUFVLEVBQUUsTUFBTTtJQUNsQixPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsYUFBYTtDQUM1QixDQUFDLENBQUM7QUFFSDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FvQkc7QUFDSCxNQUFNLFVBQVUsNkJBQTZCLENBQzVDLE1BQXFDO0lBRXJDLE9BQU87UUFDTixPQUFPLEVBQUUsZ0NBQWdDO1FBQ3pDLFFBQVEsRUFBRSxNQUFNO0tBQ2hCLENBQUM7QUFDSCxDQUFDO0FBRUQ7O0dBRUc7QUFFSCxNQUFNLE9BQU8s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Q0FBQyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxNQUFNLENBQUM7QUFDckUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdGVmZmVjdCxcblx0aW5qZWN0LFxuXHRJbmplY3RhYmxlLFxuXHRJbmplY3Rpb25Ub2tlbixcblx0SW5qZWN0b3IsXG5cdFByb3ZpZGVyLFxuXHRydW5JbkluamVjdGlvbkNvbnRleHQsXG5cdHNpZ25hbCxcblx0dW50cmFja2VkLFxuXHRXcml0YWJsZVNpZ25hbCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyB0b1NpZ25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUvcnhqcy1pbnRlcm9wJztcbmltcG9ydCB7XG5cdEFjdGl2YXRlZFJvdXRlLFxuXHROYXZpZ2F0aW9uRXh0cmFzLFxuXHRQYXJhbXMsXG5cdFJvdXRlcixcbn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGFzc2VydEluamVjdG9yIH0gZnJvbSAnbmd4dGVuc2lvbi9hc3NlcnQtaW5qZWN0b3InO1xuaW1wb3J0IHsgY3JlYXRlTm90aWZpZXIgfSBmcm9tICduZ3h0ZW5zaW9uL2NyZWF0ZS1ub3RpZmllcic7XG5pbXBvcnQgeyBleHBsaWNpdEVmZmVjdCB9IGZyb20gJ25neHRlbnNpb24vZXhwbGljaXQtZWZmZWN0JztcblxuaW1wb3J0IHsgZGlzdGluY3RVbnRpbEtleUNoYW5nZWQsIG1hcCB9IGZyb20gJ3J4anMnO1xuXG4vKipcbiAqIFRoZSB0eXBlIG9mIHRoZSBzdHJpbmdpZmllZCB2YWx1ZS5cbiAqIEFmdGVyIHRyYW5zZm9ybWluZyB0aGUgdmFsdWUgYmVmb3JlIGl0IGlzIHBhc3NlZCB0byB0aGUgcXVlcnkgcGFyYW0sIHRoaXMgdHlwZSB3aWxsIGJlIHVzZWQuXG4gKi9cbnR5cGUgU3RyaW5naWZ5UmV0dXJuVHlwZSA9IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW4gfCBudWxsIHwgdW5kZWZpbmVkO1xuXG4vKipcbiAqIFRoZXNlIGFyZSB0aGUgb3B0aW9ucyB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gdGhlIGBsaW5rZWRRdWVyeVBhcmFtYCBmdW5jdGlvbi5cbiAqIFRoZXkgYXJlIHRha2VuIGZyb20gdGhlIGBOYXZpZ2F0aW9uRXh0cmFzYCB0eXBlIGluIHRoZSBgQGFuZ3VsYXIvcm91dGVyYCBwYWNrYWdlLlxuICovXG50eXBlIE5hdmlnYXRlTWV0aG9kRmllbGRzID0gUGljazxcblx0TmF2aWdhdGlvbkV4dHJhcyxcblx0fCAncXVlcnlQYXJhbXNIYW5kbGluZydcblx0fCAnb25TYW1lVXJsTmF2aWdhdGlvbidcblx0fCAncmVwbGFjZVVybCdcblx0fCAnc2tpcExvY2F0aW9uQ2hhbmdlJ1xuXHR8ICdwcmVzZXJ2ZUZyYWdtZW50J1xuPjtcblxuY29uc3QgZGVmYXVsdENvbmZpZzogUGFydGlhbDxOYXZpZ2F0ZU1ldGhvZEZpZWxkcz4gPSB7XG5cdHF1ZXJ5UGFyYW1zSGFuZGxpbmc6ICdtZXJnZScsXG59O1xuXG5jb25zdCBfTElOS0VEX1FVRVJZX1BBUkFNX0NPTkZJR19UT0tFTiA9IG5ldyBJbmplY3Rpb25Ub2tlbjxcblx0UGFydGlhbDxOYXZpZ2F0ZU1ldGhvZEZpZWxkcz5cbj4oJ0xpbmtlZFF1ZXJ5UGFyYW1Db25maWcnLCB7XG5cdHByb3ZpZGVkSW46ICdyb290Jyxcblx0ZmFjdG9yeTogKCkgPT4gZGVmYXVsdENvbmZpZyxcbn0pO1xuXG4vKlxuICogVGhpcyBmdW5jdGlvbiBhbGxvd3MgdXNlcnMgdG8gb3ZlcnJpZGUgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgdGhlIGBsaW5rZWRRdWVyeVBhcmFtYCBuYXZpZ2F0aW9uIGV4dHJhcyBwZXIgY29tcG9uZW50LlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGB0c1xuICogQENvbXBvbmVudCh7XG4gKiAgIHByb3ZpZGVyczogW1xuICogICAgIHByb3ZpZGVMaW5rZWRRdWVyeVBhcmFtQ29uZmlnKHsgcHJlc2VydmVGcmFnbWVudDogdHJ1ZSB9KVxuICogICBdXG4gKiB9KVxuICogZXhwb3J0IGNsYXNzIE15Q29tcG9uZW50IHtcbiAqICAgLy8gTm8gbWF0dGVyIHdoaWNoIHF1ZXJ5IHBhcmFtIGNoYW5nZXMsIHRoZSBgcHJlc2VydmVGcmFnbWVudGAgb3B0aW9uXG4gKiAgIC8vIHdpbGwgYmUgc2V0IHRvIGB0cnVlYCBmb3IgYWxsIHRoZSBgbGlua2VkUXVlcnlQYXJhbWAgZnVuY3Rpb25zIGluIHRoaXMgY29tcG9uZW50LlxuICogICByZWFkb25seSBzZWFyY2hRdWVyeSA9IGxpbmtlZFF1ZXJ5UGFyYW0oJ3NlYXJjaFF1ZXJ5Jyk7XG4gKiAgIHJlYWRvbmx5IHBhZ2UgPSBsaW5rZWRRdWVyeVBhcmFtKCdwYWdlJyk7XG4gKiB9XG4gKiBgYGBcbiAqXG4gKiBBcyBhbHdheXMsIHlvdSBjYW4gb3ZlcnJpZGUgdGhpcyBiZWhhdmlvciBvbiBhIHBlci1mdW5jdGlvbiBiYXNpcyBieSBwYXNzaW5nIHRoZSBuYXZpZ2F0aW9uIGV4dHJhcyB0byB0aGUgYGxpbmtlZFF1ZXJ5UGFyYW1gIGZ1bmN0aW9uLlxuICpcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHByb3ZpZGVMaW5rZWRRdWVyeVBhcmFtQ29uZmlnKFxuXHRjb25maWc6IFBhcnRpYWw8TmF2aWdhdGVNZXRob2RGaWVsZHM+LFxuKTogUHJvdmlkZXIge1xuXHRyZXR1cm4ge1xuXHRcdHByb3ZpZGU6IF9MSU5LRURfUVVFUllfUEFSQU1fQ09ORklHX1RPS0VOLFxuXHRcdHVzZVZhbHVlOiBjb25maWcsXG5cdH07XG59XG5cbi8qKlxuICogU2VydmljZSB0byBjb2FsZXNjZSBtdWx0aXBsZSBuYXZpZ2F0aW9uIGNhbGxzIGludG8gYSBzaW5nbGUgbmF2aWdhdGlvbiBldmVudC5cbiAqL1xuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcbmV4cG9ydCBjbGFzcyBMaW5rZWRRdWVyeVBhcmFtR2xvYmFsSGFuZGxlciB7XG5cdHByaXZhdGUgX3JvdXRlciA9IGluamVjdChSb3V0ZXIpO1xuXHQvKipcblx0ICogQGludGVybmFsXG5cdCAqIFRoZSBjdXJyZW50IHF1ZXJ5IHBhcmFtcyB0aGF0IHdpbGwgYmUgc2V0IG9uIHRoZSBuZXh0IG5hdmlnYXRpb24gZXZlbnQuXG5cdCAqL1xuXHRwcml2YXRlIF9jdXJyZW50S2V5czogUmVjb3JkPHN0cmluZywgU3RyaW5naWZ5UmV0dXJuVHlwZT4gPSB7fTtcblx0LyoqXG5cdCAqIEBpbnRlcm5hbFxuXHQgKiBUaGUgbmF2aWdhdGlvbiBleHRyYXMgdGhhdCB3aWxsIGJlIHVzZWQgb24gdGhlIG5leHQgbmF2aWdhdGlvbiBldmVudC5cblx0ICovXG5cdHByaXZhdGUgX25hdmlnYXRpb25FeHRyYXM6IE5hdmlnYXRpb25FeHRyYXMgPSB7fTtcblx0LyoqXG5cdCAqIEBpbnRlcm5hbFxuXHQgKiBUaGUgbm90aWZpZXIgdGhhdCB3aWxsIGJlIHVzZWQgdG8gc2NoZWR1bGUgdGhlIG5hdmlnYXRpb24gZXZlbnQuXG5cdCAqL1xuXHRwcml2YXRlIF9zY2hlZHVsZXJOb3RpZmllciA9IGNyZWF0ZU5vdGlmaWVyKCk7XG5cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0ZWZmZWN0KCgpID0+IHtcblx0XHRcdC8vIGxpc3RlbiB0byB0aGUgc2NoZWR1bGVyIG5vdGlmaWVyIHRvIHNjaGVkdWxlIHRoZSBuYXZpZ2F0aW9uIGV2ZW50XG5cdFx0XHQvLyB3ZSB3cmFwIHRoZSBsaXN0ZW4gaW4gYSBjb25kaXRpb24gKGxpc3RlbigpIGRlZmF1bHQgdmFsdWUgaXMgMCkgaW4gb3JkZXIgdG8gbm90IHNjaGVkdWxlXG5cdFx0XHQvLyB0aGUgZmlyc3QgbmF2aWdhdGlvbiBldmVudCBieSBkZWZhdWx0LCBiZWNhdXNlIG9ubHkgY2hhbmdlcyBzaG91bGQgdHJpZ2dlciBpdFxuXHRcdFx0aWYgKHRoaXMuX3NjaGVkdWxlck5vdGlmaWVyLmxpc3RlbigpKSB7XG5cdFx0XHRcdC8vIHdlIG5lZWQgdG8gdW50cmFjayB0aGUgbmF2aWdhdGlvbiBjYWxsIGluIG9yZGVyIHRvIG5vdCByZWdpc3RlciBhbnkgb3RoZXIgc2lnbmFsIGFzIGEgZGVwZW5kZW5jeVxuXHRcdFx0XHR1bnRyYWNrZWQoKCkgPT4gdm9pZCB0aGlzLm5hdmlnYXRlKCkpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHR9XG5cblx0LyoqXG5cdCAqIFNjaGVkdWxlcyB0aGUgbmF2aWdhdGlvbiBldmVudC5cblx0ICovXG5cdHNjaGVkdWxlTmF2aWdhdGlvbigpIHtcblx0XHR0aGlzLl9zY2hlZHVsZXJOb3RpZmllci5ub3RpZnkoKTtcblx0fVxuXG5cdC8qKlxuXHQgKiBTZXRzIHRoZSB2YWx1ZSBvZiBhIHF1ZXJ5IHBhcmFtLlxuXHQgKiBUaGlzIHdpbGwgYmUgdXNlZCBvbiB0aGUgbmV4dCBuYXZpZ2F0aW9uIGV2ZW50LlxuXHQgKi9cblx0c2V0UGFyYW1LZXlWYWx1ZShrZXk6IHN0cmluZywgdmFsdWU6IFN0cmluZ2lmeVJldHVyblR5cGUpIHtcblx0XHR0aGlzLl9jdXJyZW50S2V5c1trZXldID0gdmFsdWU7XG5cdH1cblxuXHQvKipcblx0ICogU2V0cyB0aGUgbmF2aWdhdGlvbiBleHRyYXMgdGhhdCB3aWxsIGJlIHVzZWQgb24gdGhlIG5leHQgbmF2aWdhdGlvbiBldmVudC5cblx0ICovXG5cdHNldEN1cnJlbnROYXZpZ2F0aW9uRXh0cmFzKGNvbmZpZzogUGFydGlhbDxOYXZpZ2F0ZU1ldGhvZEZpZWxkcz4gPSB7fSkge1xuXHRcdGNvbnN0IHtcblx0XHRcdHF1ZXJ5UGFyYW1zSGFuZGxpbmcsXG5cdFx0XHRvblNhbWVVcmxOYXZpZ2F0aW9uLFxuXHRcdFx0cmVwbGFjZVVybCxcblx0XHRcdHNraXBMb2NhdGlvbkNoYW5nZSxcblx0XHRcdHByZXNlcnZlRnJhZ21lbnQsXG5cdFx0fSA9IGNvbmZpZztcblx0XHRpZiAocXVlcnlQYXJhbXNIYW5kbGluZyB8fCBxdWVyeVBhcmFtc0hhbmRsaW5nID09PSAnJykge1xuXHRcdFx0dGhpcy5fbmF2aWdhdGlvbkV4dHJhcy5xdWVyeVBhcmFtc0hhbmRsaW5nID0gcXVlcnlQYXJhbXNIYW5kbGluZztcblx0XHR9XG5cdFx0aWYgKG9uU2FtZVVybE5hdmlnYXRpb24pIHtcblx0XHRcdHRoaXMuX25hdmlnYXRpb25FeHRyYXMub25TYW1lVXJsTmF2aWdhdGlvbiA9IG9uU2FtZVVybE5hdmlnYXRpb247XG5cdFx0fVxuXHRcdGlmIChyZXBsYWNlVXJsKSB7XG5cdFx0XHR0aGlzLl9uYXZpZ2F0aW9uRXh0cmFzLnJlcGxhY2VVcmwgPSByZXBsYWNlVXJsO1xuXHRcdH1cblx0XHRpZiAoc2tpcExvY2F0aW9uQ2hhbmdlKSB7XG5cdFx0XHR0aGlzLl9uYXZpZ2F0aW9uRXh0cmFzLnNraXBMb2NhdGlvbkNoYW5nZSA9IHNraXBMb2NhdGlvbkNoYW5nZTtcblx0XHR9XG5cdFx0aWYgKHByZXNlcnZlRnJhZ21lbnQpIHtcblx0XHRcdHRoaXMuX25hdmlnYXRpb25FeHRyYXMucHJlc2VydmVGcmFnbWVudCA9IHByZXNlcnZlRnJhZ21lbnQ7XG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIE5hdmlnYXRlcyB0byB0aGUgY3VycmVudCBVUkwgd2l0aCB0aGUgYWNjdW11bGF0ZWQgcXVlcnkgcGFyYW1ldGVycyBhbmQgbmF2aWdhdGlvbiBleHRyYXMuXG5cdCAqIENsZWFucyB1cCB0aGUgY3VycmVudCBrZXlzIGFuZCBuYXZpZ2F0aW9uIGV4dHJhcyBhZnRlciB0aGUgbmF2aWdhdGlvbi5cblx0ICovXG5cdHByaXZhdGUgbmF2aWdhdGUoKTogUHJvbWlzZTxib29sZWFuPiB7XG5cdFx0cmV0dXJuIHRoaXMuX3JvdXRlclxuXHRcdFx0Lm5hdmlnYXRlKFtdLCB7XG5cdFx0XHRcdHF1ZXJ5UGFyYW1zOiB0aGlzLl9jdXJyZW50S2V5cyxcblx0XHRcdFx0Li4udGhpcy5fbmF2aWdhdGlvbkV4dHJhcywgLy8gb3ZlcnJpZGUgdGhlIG5hdmlnYXRpb24gZXh0cmFzXG5cdFx0XHR9KVxuXHRcdFx0LnRoZW4oKHZhbHVlKSA9PiB7XG5cdFx0XHRcdC8vIHdlIHJlc2V0IHRoZSBjdXJyZW50IGtleXMgYW5kIG5hdmlnYXRpb24gZXh0cmFzIG9uIG5hdmlnYXRpb25cblx0XHRcdFx0Ly8gaW4gb3JkZXIgdG8gYXZvaWQgbGVha2luZyB0byBvdGhlciBuYXZpZ2F0aW9uc1xuXHRcdFx0XHR0aGlzLl9jdXJyZW50S2V5cyA9IHt9O1xuXHRcdFx0XHR0aGlzLl9uYXZpZ2F0aW9uRXh0cmFzID0ge307XG5cdFx0XHRcdHJldHVybiB2YWx1ZTtcblx0XHRcdH0pO1xuXHR9XG59XG5cbnR5cGUgTGlua2VkUXVlcnlQYXJhbU9wdGlvbnMgPSB7XG5cdC8qKlxuXHQgKiBUaGUgaW5qZWN0b3IgdG8gdXNlIHRvIGluamVjdCB0aGUgcm91dGVyIGFuZCBhY3RpdmF0ZWQgcm91dGUuXG5cdCAqL1xuXHRpbmplY3Rvcj86IEluamVjdG9yO1xufSAmIFBhcnRpYWw8TmF2aWdhdGVNZXRob2RGaWVsZHM+O1xuXG4vKipcbiAqIFRoZXNlIGFyZSB0aGUgZnVuY3Rpb24gdHlwZXMgdGhhdCB3aWxsIGJlIHVzZWQgdG8gcGFyc2UgYW5kIHN0cmluZ2lmeSB0aGUgcXVlcnkgcGFyYW0gdmFsdWUuXG4gKi9cbnR5cGUgUGFyc2VGbjxUPiA9ICh2YWx1ZTogc3RyaW5nIHwgbnVsbCkgPT4gVDtcbnR5cGUgU3RyaW5naWZ5Rm48VD4gPSAodmFsdWU6IFQpID0+IFN0cmluZ2lmeVJldHVyblR5cGU7XG5cbi8qKlxuICpUaGVzZSB0eXBlcyB3aWxsIGJlIHVzZWQgdG8gZGVmaW5lIHRoZSByZXR1cm4gdHlwZXMgb2YgdGhlIGBzZXRgIGFuZCBgdXBkYXRlYCBtZXRob2RzIG9mIHRoZSBzaWduYWwuXG4gKiBXZSBuZWVkIHRvIHJlLXR5cGUgdGhlIFdyaXRhYmxlU2lnbmFsLCBzbyB0aGF0IHRoZSBzZXQgYW5kIHVwZGF0ZSBtZXRob2RzIGNhbiBoYXZlIG51bGwgaW4gdGhlIGNhbGwgc2lnbmF0dXJlLlxuICogQnV0IHRoZSBXcml0YWJsZVNpZ25hbCBpdHNlbGYgd29uJ3QgaGF2ZSBudWxsIGluIHRoZSBjYWxsIHNpZ25hdHVyZSwgc28gd2UgbmVlZCB0byByZS10eXBlIGl0LlxuICogVGhpcyBpcyBuZWVkZWQgaW4gb3JkZXIgdG8gYmUgYWJsZSB0byByZXNldCB0aGUgdmFsdWUgdG8gbnVsbCxcbiAqIHdoaWNoIGlzIG5vdCBwb3NzaWJsZSB3aXRoIHRoZSBXcml0YWJsZVNpZ25hbCB0aGF0IGRvZXNuJ3QgaGF2ZSBudWxsIGluIGl0J3MgdHlwZS5cbiAqL1xudHlwZSBTaWduYWxTZXRGbjxUPiA9ICh2YWx1ZTogVCkgPT4gdm9pZDtcbnR5cGUgU2lnbmFsVXBkYXRlRm48VD4gPSAoZm46ICh2YWx1ZTogVCkgPT4gVCkgPT4gdm9pZDtcblxuLyoqXG4gKiBDcmVhdGVzIGEgc2lnbmFsIHRoYXQgaXMgbGlua2VkIHRvIGEgcXVlcnkgcGFyYW1ldGVyLlxuICpcbiAqIFlvdSBjYW4gcGFyc2UgdGhlIHF1ZXJ5IHBhcmFtIHZhbHVlIGJlZm9yZSBpdCBpcyBwYXNzZWQgdG8gdGhlIHNpZ25hbCwgdGhpcyB3YXkgeW91IGNhbiB0cmFuc2Zvcm0gdGhlIHZhbHVlIGZyb20gYSBzdHJpbmcgdG8gYSBudW1iZXIgb3IgYm9vbGVhbiBvciB3aGF0ZXZlciB5b3UgbmVlZC5cbiAqIFlvdSBjYW4gYWxzbyBzdHJpbmdpZnkgdGhlIHZhbHVlIGJlZm9yZSBpdCBpcyBwYXNzZWQgdG8gdGhlIHF1ZXJ5IHBhcmFtLCB0aGlzIHdheSB5b3UgY2FuIHN0cmluZ2lmeSB0aGUgdmFsdWUgZnJvbSBhIG51bWJlciBvciBib29sZWFuIG9yIG9iamVjdCB0byBhIHN0cmluZyBvciBudWxsLlxuICpcbiAqIFlvdSBjYW4gYWxzbyB1c2UgdGhlIGBkZWZhdWx0VmFsdWVgIG9wdGlvbiB0byBzZXQgYSBkZWZhdWx0IHZhbHVlIGlmIHRoZSBxdWVyeSBwYXJhbSBpcyBub3QgcHJlc2VudCBpbiB0aGUgdXJsIChudWxsIG9yIHVuZGVmaW5lZCkuXG4gKiBOT1RFOiBZb3UgY2Fubm90IHVzZSBib3RoIGBkZWZhdWx0VmFsdWVgIGFuZCBgcGFyc2VgIGF0IHRoZSBzYW1lIHRpbWUuIFlvdSBzaG91bGQgdXNlIGBwYXJzZWAgaW5zdGVhZCB0byBoYW5kbGUgdGhlIGRlZmF1bHQgdmFsdWUuXG4gKlxuICogWW91IGNhbiBzZXQgdGhlIHNpZ25hbCB0byB1cGRhdGUgdGhlIHF1ZXJ5IHBhcmFtZXRlciBieSBjYWxsaW5nIHRoZSBgc2V0YCBvciBgdXBkYXRlYCBtZXRob2QuXG4gKiBCb3RoIG1ldGhvZHMgd2lsbCBhY2NlcHQgdGhlIHZhbHVlICsgbnVsbCBhcyBhIHZhbGlkIHZhbHVlLCBzbyB5b3UgY2FuIHJlbW92ZSB0aGUgcXVlcnkgcGFyYW1ldGVyIGJ5IHBhc3NpbmcgbnVsbCBpZiBuZWVkZWQuXG4gKlxuICogVGhlICdzZXQnIGFuZCAndXBkYXRlJyBtZXRob2RzIHdpbGwgdXBkYXRlIHRoZSB2YWx1ZSBzeW5jaHJvbm91c2x5LCBidXQgd2lsbCBzY2hlZHVsZSB0aGUgbmF2aWdhdGlvbiBldmVudCB0b1xuICogaGFwcGVuIG9uIHRoZSBuZXh0IHRpY2sgKHVzaW5nIHJvb3QgZWZmZWN0IHNjaGVkdWxpbmcpLiBUaGlzIG1lYW5zIHRoZSBxdWVyeSBwYXJhbXMgd2lsbCBiZSB1cGRhdGVkIGFzeW5jaHJvbm91c2x5LlxuICogVGhlIGNoYW5nZXMgd2lsbCBiZSBjb2FsZXNjZWQgaW50byBhIHNpbmdsZSBuYXZpZ2F0aW9uIGV2ZW50LiBUaGlzIG1lYW5zIHRoYXQgaWYgeW91IGNhbGwgYHNldGAgb3IgYHVwZGF0ZWAgbXVsdGlwbGUgdGltZXNcbiAqIGluIGEgcm93IChzeW5jaHJvbm91c2x5KSwgb25seSB0aGUgbGFzdCB2YWx1ZSB3aWxsIGJlIHVwZGF0ZWQgaW4gdGhlIHF1ZXJ5IHBhcmFtcy5cbiAqXG4gKiBJZiB5b3UgaGF2ZSBtdWx0aXBsZSBzaWduYWxzIGxpc3RlbmluZyB0byB0aGUgc2FtZSBxdWVyeSBwYXJhbWV0ZXIsIHRoZXkgd2lsbCBhbGwgYmUgdXBkYXRlZCB3aGVuIHRoZSBuYXZpZ2F0aW9uIGV2ZW50IGhhcHBlbnMuXG4gKlxuICogQHBhcmFtIGtleSBUaGUgbmFtZSBvZiB0aGUgcXVlcnkgcGFyYW1ldGVyLlxuICogQHBhcmFtIG9wdGlvbnMgQ29uZmlndXJhdGlvbiBvcHRpb25zIGZvciB0aGUgc2lnbmFsLlxuICogQHJldHVybnMgQSBzaWduYWwgdGhhdCBpcyBsaW5rZWQgdG8gdGhlIHF1ZXJ5IHBhcmFtZXRlci5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGxpbmtlZFF1ZXJ5UGFyYW08VCA9IHN0cmluZz4oXG5cdGtleTogc3RyaW5nLFxuXHRvcHRpb25zOiBMaW5rZWRRdWVyeVBhcmFtT3B0aW9ucyAmIHtcblx0XHRwYXJzZTogUGFyc2VGbjxUPjtcblx0XHRzdHJpbmdpZnk6IFN0cmluZ2lmeUZuPFQ+O1xuXHR9LFxuKTogV3JpdGFibGVTaWduYWw8VD4gJiB7XG5cdHNldDogU2lnbmFsU2V0Rm48VCB8IG51bGw+O1xuXHR1cGRhdGU6IFNpZ25hbFVwZGF0ZUZuPFQgfCBudWxsPjtcbn07XG5cbi8qKlxuICogWW91IGNhbm5vdCB1c2UgYm90aCBgZGVmYXVsdFZhbHVlYCBhbmQgYHBhcnNlYCBhdCB0aGUgc2FtZSB0aW1lLlxuICogWW91IHNob3VsZCB1c2UgYHBhcnNlYCBpbnN0ZWFkIHRvIGhhbmRsZSB0aGUgZGVmYXVsdCB2YWx1ZS5cbiAqXG4gKiBGb3IgZXhhbXBsZSwgeW91IGNhbm5vdCBkbyB0aGlzOlxuICpcbiAqIGBgYHRzXG4gKiBsaW5rZWRRdWVyeVBhcmFtKCdwYXJhbScsIHsgZGVmYXVsdFZhbHVlOiAxLCBwYXJzZTogKHgpID0+IHggPyBwYXJzZUludCh4LCAxMCkgOiB4IH0pO1xuICogYGBgXG4gKlxuICogSW5zdGVhZCwgeW91IHNob3VsZCBkbyB0aGlzOlxuICpcbiAqIGBgYHRzXG4gKiBsaW5rZWRRdWVyeVBhcmFtKCdwYXJhbScsIHsgcGFyc2U6ICh4KSA9PiB4ID8gcGFyc2VJbnQoeCwgMTApIDogMSB9KTtcbiAqIGBgYFxuICovXG5leHBvcnQgZnVuY3Rpb24gbGlua2VkUXVlcnlQYXJhbTxUID0gc3RyaW5nPihcblx0a2V5OiBzdHJpbmcsXG5cdG9wdGlvbnM6IExpbmtlZFF1ZXJ5UGFyYW1PcHRpb25zICYge1xuXHRcdGRlZmF1bHRWYWx1ZTogRXhjbHVkZTxULCB1bmRlZmluZWQ+O1xuXHRcdHBhcnNlOiBQYXJzZUZuPFQ+O1xuXHRcdHN0cmluZ2lmeT86IFN0cmluZ2lmeUZuPFQ+O1xuXHR9LFxuKTogbmV2ZXI7XG5cbmV4cG9ydCBmdW5jdGlvbiBsaW5rZWRRdWVyeVBhcmFtPFQgPSBzdHJpbmc+KFxuXHRrZXk6IHN0cmluZyxcblx0b3B0aW9uczogTGlua2VkUXVlcnlQYXJhbU9wdGlvbnMgJiB7XG5cdFx0ZGVmYXVsdFZhbHVlOiBUO1xuXHRcdHN0cmluZ2lmeTogU3RyaW5naWZ5Rm48VD47XG5cdH0sXG4pOiBXcml0YWJsZVNpZ25hbDxUIHwgbnVsbD47XG5cbmV4cG9ydCBmdW5jdGlvbiBsaW5rZWRRdWVyeVBhcmFtPFQ+KFxuXHRrZXk6IHN0cmluZyxcblx0b3B0aW9uczogTGlua2VkUXVlcnlQYXJhbU9wdGlvbnMgJiB7IGRlZmF1bHRWYWx1ZTogVCB9LFxuKTogV3JpdGFibGVTaWduYWw8VD4gJiB7XG5cdHNldDogU2lnbmFsU2V0Rm48VCB8IG51bGw+O1xuXHR1cGRhdGU6IFNpZ25hbFVwZGF0ZUZuPFQgfCBudWxsPjtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBsaW5rZWRRdWVyeVBhcmFtPFQ+KFxuXHRrZXk6IHN0cmluZyxcblx0b3B0aW9uczogTGlua2VkUXVlcnlQYXJhbU9wdGlvbnMgJiB7IGRlZmF1bHRWYWx1ZTogVCB8IG51bGwgfSxcbik6IFdyaXRhYmxlU2lnbmFsPFQgfCBudWxsPjtcblxuZXhwb3J0IGZ1bmN0aW9uIGxpbmtlZFF1ZXJ5UGFyYW08VD4oXG5cdGtleTogc3RyaW5nLFxuXHRvcHRpb25zOiBMaW5rZWRRdWVyeVBhcmFtT3B0aW9ucyAmIHsgZGVmYXVsdFZhbHVlOiBUIHwgdW5kZWZpbmVkIH0sXG4pOiBXcml0YWJsZVNpZ25hbDxUIHwgdW5kZWZpbmVkPjtcblxuZXhwb3J0IGZ1bmN0aW9uIGxpbmtlZFF1ZXJ5UGFyYW08VCA9IHN0cmluZz4oXG5cdGtleTogc3RyaW5nLFxuXHRvcHRpb25zOiBMaW5rZWRRdWVyeVBhcmFtT3B0aW9ucyAmIHsgZGVmYXVsdFZhbHVlOiB1bmRlZmluZWQgfSxcbik6IFdyaXRhYmxlU2lnbmFsPFQgfCBudWxsPjtcblxuZXhwb3J0IGZ1bmN0aW9uIGxpbmtlZFF1ZXJ5UGFyYW08VD4oXG5cdGtleTogc3RyaW5nLFxuXHRvcHRpb25zOiBMaW5rZWRRdWVyeVBhcmFtT3B0aW9ucyAmIHsgcGFyc2U6IFBhcnNlRm48VD4gfSxcbik6IFdyaXRhYmxlU2lnbmFsPFQ+ICYge1xuXHRzZXQ6IFNpZ25hbFNldEZuPFQgfCBudWxsPjtcblx0dXBkYXRlOiBTaWduYWxVcGRhdGVGbjxUIHwgbnVsbD47XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gbGlua2VkUXVlcnlQYXJhbTxUID0gc3RyaW5nPihcblx0a2V5OiBzdHJpbmcsXG5cdG9wdGlvbnM6IExpbmtlZFF1ZXJ5UGFyYW1PcHRpb25zICYgeyBzdHJpbmdpZnk6IFN0cmluZ2lmeUZuPFQ+IH0sXG4pOiBXcml0YWJsZVNpZ25hbDxUIHwgbnVsbD47XG5cbmV4cG9ydCBmdW5jdGlvbiBsaW5rZWRRdWVyeVBhcmFtPFQgPSBzdHJpbmc+KFxuXHRrZXk6IHN0cmluZyxcblx0b3B0aW9uczogTGlua2VkUXVlcnlQYXJhbU9wdGlvbnMsXG4pOiBXcml0YWJsZVNpZ25hbDxUIHwgbnVsbD47XG5cbmV4cG9ydCBmdW5jdGlvbiBsaW5rZWRRdWVyeVBhcmFtPFQgPSBzdHJpbmc+KFxuXHRrZXk6IHN0cmluZyxcbik6IFdyaXRhYmxlU2lnbmFsPFQgfCBudWxsPjtcblxuZXhwb3J0IGZ1bmN0aW9uIGxpbmtlZFF1ZXJ5UGFyYW08VD4oXG5cdGtleTogc3RyaW5nLFxuXHRvcHRpb25zPzogTGlua2VkUXVlcnlQYXJhbU9wdGlvbnMgJiB7XG5cdFx0ZGVmYXVsdFZhbHVlPzogVDtcblx0XHRwYXJzZT86IFBhcnNlRm48VD47XG5cdFx0c3RyaW5naWZ5PzogU3RyaW5naWZ5Rm48VD47XG5cdH0sXG4pOiBXcml0YWJsZVNpZ25hbDxUPiB7XG5cdGlmIChvcHRpb25zPy5kZWZhdWx0VmFsdWUgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zPy5wYXJzZSkge1xuXHRcdHRocm93IG5ldyBFcnJvcihcblx0XHRcdCdsaW5rZWRRdWVyeVBhcmFtOiBZb3UgY2Fubm90IGhhdmUgYm90aCBkZWZhdWx0VmFsdWUgYW5kIHBhcnNlIGF0IHRoZSBzYW1lIHRpbWUhJyxcblx0XHQpO1xuXHR9XG5cblx0Y29uc3QgaW5qZWN0b3IgPSBhc3NlcnRJbmplY3RvcihsaW5rZWRRdWVyeVBhcmFtLCBvcHRpb25zPy5pbmplY3Rvcik7XG5cblx0cmV0dXJuIHJ1bkluSW5qZWN0aW9uQ29udGV4dChpbmplY3RvciwgKCkgPT4ge1xuXHRcdGNvbnN0IHJvdXRlID0gaW5qZWN0KEFjdGl2YXRlZFJvdXRlKTtcblx0XHRjb25zdCBnbG9iYWxIYW5kbGVyID0gaW5qZWN0KExpbmtlZFF1ZXJ5UGFyYW1HbG9iYWxIYW5kbGVyKTtcblx0XHRjb25zdCBjb25maWcgPSBpbmplY3QoX0xJTktFRF9RVUVSWV9QQVJBTV9DT05GSUdfVE9LRU4pO1xuXG5cdFx0LyoqXG5cdFx0ICogUGFyc2VzIGEgcGFyYW1ldGVyIHZhbHVlIGJhc2VkIG9uIHByb3ZpZGVkIGNvbmZpZ3VyYXRpb24uXG5cdFx0ICogQHBhcmFtIHBhcmFtcyAtIEFuIG9iamVjdCBjb250YWluaW5nIHBhcmFtZXRlcnMuXG5cdFx0ICogQHJldHVybnMgVGhlIHBhcnNlZCBwYXJhbWV0ZXIgdmFsdWUuXG5cdFx0ICovXG5cdFx0Y29uc3QgcGFyc2VQYXJhbVZhbHVlID0gKHBhcmFtczogUGFyYW1zKSA9PiB7XG5cdFx0XHQvLyBHZXQgdGhlIHZhbHVlIGZyb20gdGhlIHBhcmFtcyBvYmplY3QuXG5cdFx0XHRjb25zdCB2YWx1ZTogc3RyaW5nIHwgbnVsbCA9IHBhcmFtc1trZXldID8/IG51bGw7XG5cdFx0XHQvLyBJZiBhIHBhcnNpbmcgZnVuY3Rpb24gaXMgcHJvdmlkZWQgaW4gdGhlIGNvbmZpZywgdXNlIGl0IHRvIHBhcnNlIHRoZSB2YWx1ZS5cblx0XHRcdGlmIChvcHRpb25zPy5wYXJzZSkge1xuXHRcdFx0XHRyZXR1cm4gb3B0aW9ucy5wYXJzZSh2YWx1ZSk7XG5cdFx0XHR9XG5cdFx0XHQvLyBJZiB0aGUgdmFsdWUgaXMgdW5kZWZpbmVkIG9yIG51bGwgYW5kIGEgZGVmYXVsdCB2YWx1ZSBpcyBwcm92aWRlZCwgcmV0dXJuIHRoZSBkZWZhdWx0IHZhbHVlLlxuXHRcdFx0aWYgKFxuXHRcdFx0XHQodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkgJiZcblx0XHRcdFx0b3B0aW9ucz8uZGVmYXVsdFZhbHVlICE9PSB1bmRlZmluZWRcblx0XHRcdCkge1xuXHRcdFx0XHRyZXR1cm4gb3B0aW9ucy5kZWZhdWx0VmFsdWU7XG5cdFx0XHR9XG5cdFx0XHQvLyBPdGhlcndpc2UsIHJldHVybiB0aGUgb3JpZ2luYWwgdmFsdWUgb3IgdGhlIHBhcnNlZCB2YWx1ZSAoaWYgaXQgd2FzIHBhcnNlZCkuXG5cdFx0XHRyZXR1cm4gdmFsdWU7XG5cdFx0fTtcblxuXHRcdC8vIGNyZWF0ZSBhIHNpZ25hbCB0aGF0IGlzIHVwZGF0ZWQgd2hlbmV2ZXIgdGhlIHF1ZXJ5IHBhcmFtIGNoYW5nZXNcblx0XHRjb25zdCBxdWVyeVBhcmFtVmFsdWUgPSB0b1NpZ25hbChcblx0XHRcdHJvdXRlLnF1ZXJ5UGFyYW1zLnBpcGUoXG5cdFx0XHRcdGRpc3RpbmN0VW50aWxLZXlDaGFuZ2VkKGtleSksIC8vIHNraXAgaWYgbm8gY2hhbmdlcyBvbiBzYW1lIGtleVxuXHRcdFx0XHRtYXAoKHgpID0+IHBhcnNlUGFyYW1WYWx1ZSh4KSksXG5cdFx0XHQpLFxuXHRcdFx0eyBpbml0aWFsVmFsdWU6IHBhcnNlUGFyYW1WYWx1ZShyb3V0ZS5zbmFwc2hvdC5xdWVyeVBhcmFtcykgfSxcblx0XHQpO1xuXG5cdFx0Y29uc3Qgc291cmNlID0gc2lnbmFsPFQ+KHF1ZXJ5UGFyYW1WYWx1ZSgpIGFzIFQpO1xuXG5cdFx0Y29uc3Qgb3JpZ2luYWxTZXQgPSBzb3VyY2Uuc2V0O1xuXG5cdFx0ZXhwbGljaXRFZmZlY3QoW3F1ZXJ5UGFyYW1WYWx1ZV0sIChbdmFsdWVdKSA9PiB7XG5cdFx0XHQvLyB1cGRhdGUgdGhlIHNvdXJjZSBzaWduYWwgd2hlbmV2ZXIgdGhlIHF1ZXJ5IHBhcmFtIGNoYW5nZXNcblx0XHRcdG9yaWdpbmFsU2V0KHZhbHVlIGFzIFQpO1xuXHRcdH0pO1xuXG5cdFx0Y29uc3Qgc2V0ID0gKHZhbHVlOiBUKSA9PiB7XG5cdFx0XHQvLyBmaXJzdCB3ZSBjaGVjayBpZiB0aGUgdmFsdWUgaXMgdW5kZWZpbmVkIG9yIG51bGwgc28gd2UgY2FuIHNldCB0aGUgZGVmYXVsdCB2YWx1ZSBpbnN0ZWFkXG5cdFx0XHRpZiAoXG5cdFx0XHRcdCh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSAmJlxuXHRcdFx0XHRvcHRpb25zPy5kZWZhdWx0VmFsdWUgIT09IHVuZGVmaW5lZFxuXHRcdFx0KSB7XG5cdFx0XHRcdHZhbHVlID0gb3B0aW9ucy5kZWZhdWx0VmFsdWU7XG5cdFx0XHR9XG5cblx0XHRcdC8vIHdlIGZpcnN0IHNldCB0aGUgaW5pdGlhbCB2YWx1ZSBzbyBpdCBzeW5jaHJvbm91cyAoc2FtZSBhcyBhIG5vcm1hbCBzaWduYWwpXG5cdFx0XHRvcmlnaW5hbFNldCh2YWx1ZSk7XG5cblx0XHRcdC8vIHdoZW4gdGhlIHNvdXJjZSBzaWduYWwgY2hhbmdlcywgdXBkYXRlIHRoZSBxdWVyeSBwYXJhbVxuXHRcdFx0Ly8gc3RvcmUgdGhlIG5ldyB2YWx1ZSBpbiB0aGUgY3VycmVudCBrZXlzIHNvIHRoYXQgd2UgY2FuIGNvYWxlc2NlIHRoZSBuYXZpZ2F0aW9uXG5cdFx0XHRsZXQgdmFsdWVUb0JlU2V0OiBhbnkgPSB2YWx1ZTtcblx0XHRcdGlmIChvcHRpb25zPy5zdHJpbmdpZnkpIHtcblx0XHRcdFx0dmFsdWVUb0JlU2V0ID0gb3B0aW9ucy5zdHJpbmdpZnkodmFsdWUpO1xuXHRcdFx0fSBlbHNlIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSB7XG5cdFx0XHRcdHZhbHVlVG9CZVNldCA9IG51bGw7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR2YWx1ZVRvQmVTZXQgPSB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnID8gdmFsdWUgOiBTdHJpbmcodmFsdWUpO1xuXHRcdFx0fVxuXG5cdFx0XHRnbG9iYWxIYW5kbGVyLnNldFBhcmFtS2V5VmFsdWUoa2V5LCB2YWx1ZVRvQmVTZXQpO1xuXHRcdFx0Z2xvYmFsSGFuZGxlci5zZXRDdXJyZW50TmF2aWdhdGlvbkV4dHJhcyh7XG5cdFx0XHRcdC4uLmRlZmF1bHRDb25maWcsXG5cdFx0XHRcdC4uLmNvbmZpZyxcblx0XHRcdFx0Li4uKG9wdGlvbnMgPz8ge30pLFxuXHRcdFx0fSk7XG5cblx0XHRcdC8vIHNjaGVkdWxlIHRoZSBuYXZpZ2F0aW9uIGV2ZW50IChtdWx0aXBsZSBzeW5jaHJvbm91cyBuYXZpZ2F0aW9ucyB3aWxsIGJlIGNvYWxlc2NlZClcblx0XHRcdC8vIHRoaXMgd2lsbCBhbHNvIHJlc2V0IHRoZSBjdXJyZW50IGtleXMgYW5kIG5hdmlnYXRpb24gZXh0cmFzIGFmdGVyIHRoZSBuYXZpZ2F0aW9uXG5cdFx0XHRnbG9iYWxIYW5kbGVyLnNjaGVkdWxlTmF2aWdhdGlvbigpO1xuXHRcdH07XG5cblx0XHRjb25zdCB1cGRhdGUgPSAoZm46ICh2YWx1ZTogVCkgPT4gVCkgPT4gc2V0KGZuKHNvdXJjZSgpKSk7XG5cblx0XHRyZXR1cm4gT2JqZWN0LmFzc2lnbihzb3VyY2UsIHsgc2V0LCB1cGRhdGUgfSk7XG5cdH0pO1xufVxuXG4vKipcbiAqIENhbiBiZSB1c2VkIHRvIHBhcnNlIGEgcXVlcnkgcGFyYW0gdmFsdWUgdG8gYSBudW1iZXIuXG4gKiBZb3UgY2FuIGFsc28gdXNlIHRoZSBgZGVmYXVsdFZhbHVlYCBvcHRpb24gdG8gc2V0IGEgZGVmYXVsdCB2YWx1ZSBpZiB0aGUgcXVlcnkgcGFyYW0gaXMgbm90IHByZXNlbnQgaW4gdGhlIHVybCAobnVsbCBvciB1bmRlZmluZWQpLlxuICpcbiAqIEV4YW1wbGU6XG4gKiBgYGB0c1xuICogbGlua2VkUXVlcnlQYXJhbSgncGFnZScsIHsgcGFyc2U6IHBhcmFtVG9OdW1iZXIoKSB9KTtcbiAqIGBgYFxuICogV2lsbCByZXR1cm4gbnVsbCBpZiB0aGUgcXVlcnkgcGFyYW0gaXMgbm90IHByZXNlbnQgaW4gdGhlIHVybC5cbiAqXG4gKiBPciB3aXRoIGEgZGVmYXVsdCB2YWx1ZTpcbiAqIGBgYHRzXG4gKiBsaW5rZWRRdWVyeVBhcmFtKCdwYWdlJywgeyBwYXJzZTogcGFyYW1Ub051bWJlcih7ZGVmYXVsdFZhbHVlOiAxfSkgfSk7XG4gKiBgYGBcbiAqXG4gKiBXaWxsIHJldHVybiAxIGlmIHRoZSBxdWVyeSBwYXJhbSBpcyBub3QgcHJlc2VudCBpbiB0aGUgdXJsLlxuICovXG5leHBvcnQgZnVuY3Rpb24gcGFyYW1Ub051bWJlcigpOiAoeDogc3RyaW5nIHwgbnVsbCkgPT4gbnVtYmVyIHwgbnVsbDtcbmV4cG9ydCBmdW5jdGlvbiBwYXJhbVRvTnVtYmVyKGNvbmZpZzoge1xuXHRkZWZhdWx0VmFsdWU6IG51bWJlcjtcbn0pOiAoeDogc3RyaW5nIHwgbnVsbCkgPT4gbnVtYmVyO1xuXG5leHBvcnQgZnVuY3Rpb24gcGFyYW1Ub051bWJlcihcblx0Y29uZmlnOiB7IGRlZmF1bHRWYWx1ZT86IG51bWJlciB8IG51bGwgfCB1bmRlZmluZWQgfSA9IHsgZGVmYXVsdFZhbHVlOiBudWxsIH0sXG4pIHtcblx0cmV0dXJuICh4OiBzdHJpbmcgfCBudWxsKSA9PiB7XG5cdFx0aWYgKHggPT09IHVuZGVmaW5lZCB8fCB4ID09PSBudWxsKSByZXR1cm4gY29uZmlnLmRlZmF1bHRWYWx1ZTtcblx0XHRjb25zdCBwYXJzZWQgPSBwYXJzZUludCh4LCAxMCk7XG5cdFx0aWYgKE51bWJlci5pc05hTihwYXJzZWQpKSByZXR1cm4gY29uZmlnLmRlZmF1bHRWYWx1ZTtcblx0XHRyZXR1cm4gcGFyc2VkO1xuXHR9O1xufVxuXG4vKipcbiAqIENhbiBiZSB1c2VkIHRvIHBhcnNlIGEgcXVlcnkgcGFyYW0gdmFsdWUgdG8gYSBib29sZWFuLlxuICogWW91IGNhbiBhbHNvIHVzZSB0aGUgYGRlZmF1bHRWYWx1ZWAgb3B0aW9uIHRvIHNldCBhIGRlZmF1bHQgdmFsdWUgaWYgdGhlIHF1ZXJ5IHBhcmFtIGlzIG5vdCBwcmVzZW50IGluIHRoZSB1cmwgKG51bGwgb3IgdW5kZWZpbmVkKS5cbiAqXG4gKiBFeGFtcGxlOlxuICogYGBgdHNcbiAqIGxpbmtlZFF1ZXJ5UGFyYW0oJ3Nob3dIaWRkZW4nLCB7IHBhcnNlOiBwYXJhbVRvQm9vbGVhbigpIH0pO1xuICogYGBgXG4gKiBXaWxsIHJldHVybiBudWxsIGlmIHRoZSBxdWVyeSBwYXJhbSBpcyBub3QgcHJlc2VudCBpbiB0aGUgdXJsIG9yIHRydWUvZmFsc2UgaWYgdGhlIHF1ZXJ5IHBhcmFtIGlzIHByZXNlbnQuXG4gKlxuICogT3Igd2l0aCBhIGRlZmF1bHQgdmFsdWU6XG4gKiBgYGB0c1xuICogbGlua2VkUXVlcnlQYXJhbSgnc2hvd0hpZGRlbicsIHsgcGFyc2U6IHBhcmFtVG9Cb29sZWFuKHtkZWZhdWx0VmFsdWU6IHRydWV9KSB9KTtcbiAqIGBgYFxuICpcbiAqIFdpbGwgcmV0dXJuIHRydWUgaWYgdGhlIHF1ZXJ5IHBhcmFtIGlzIG5vdCBwcmVzZW50IGluIHRoZSB1cmwuXG4gKiBPdGhlcndpc2UsIGl0IHdpbGwgcmV0dXJuIHdoYXRldmVyIHRoZSBxdWVyeSBwYXJhbSB2YWx1ZSBpcy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHBhcmFtVG9Cb29sZWFuKCk6ICh4OiBzdHJpbmcgfCBudWxsKSA9PiBib29sZWFuIHwgbnVsbDtcbmV4cG9ydCBmdW5jdGlvbiBwYXJhbVRvQm9vbGVhbihjb25maWc6IHtcblx0ZGVmYXVsdFZhbHVlOiBib29sZWFuO1xufSk6ICh4OiBzdHJpbmcgfCBudWxsKSA9PiBib29sZWFuO1xuXG5leHBvcnQgZnVuY3Rpb24gcGFyYW1Ub0Jvb2xlYW4oXG5cdGNvbmZpZzogeyBkZWZhdWx0VmFsdWU/OiBib29sZWFuIHwgbnVsbCB8IHVuZGVmaW5lZCB9ID0ge1xuXHRcdGRlZmF1bHRWYWx1ZTogbnVsbCxcblx0fSxcbikge1xuXHRyZXR1cm4gKHg6IHN0cmluZyB8IG51bGwpID0+XG5cdFx0eCA9PT0gdW5kZWZpbmVkIHx8IHggPT09IG51bGwgPyBjb25maWcuZGVmYXVsdFZhbHVlIDogeCA9PT0gJ3RydWUnO1xufVxuIl19